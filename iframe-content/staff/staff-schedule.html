<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Розклад вчителя</title>
    <link rel="stylesheet" href="https://yehormovchan.github.io/static/style.css">
    <link rel="stylesheet" href="https://yehormovchan.github.io/static/iframe-styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://yehormovchan.github.io/static/script.js"></script>
    <style>
        .groups-table {
            margin-top: 30px;
            width: 100%;
            border-collapse: collapse;
        }
        .groups-table th, .groups-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .groups-table th {
            background-color: #f2f2f2;
        }
        .groups-table caption {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        .day-column {
            font-weight: bold;
            background-color: #f8f8f8;
        }
    </style>
</head>
<body>
    <table>
        <thead>
            <tr>
                <th>Номер уроку</th>
                <th>Понеділок</th>
                <th>Вівторок</th>
                <th>Середа</th>
                <th>Четвер</th>
                <th>П'ятниця</th>
            </tr>
        </thead>
        <tbody id="schedule-body">
        </tbody>
    </table>

    <!-- Нова таблиця для розкладу груп -->
    <table class="groups-table">
        <caption>Розклад груп</caption>
        <thead>
            <tr>
                <th>День тижня</th>
                <th>Група</th>
                <th>Час початку</th>
                <th>Час закінчення</th>
                <th>Дії</th>
            </tr>
        </thead>
        <tbody id="groups-schedule-body">
        </tbody>
    </table>

    <div id="attendance-modal" class="modal hidden">
        <div class="wrapper edit-wrapper">
            <h2 id="lesson-info"></h2>
            <label for="date-select">Оберіть дату:</label>
            <select id="date-select"></select>
            <h3>Присутні:</h3>
            <ul id="student-list"></ul>
            <button id="save-attendance">Зберегти</button> <br>
            <button id="close-attendance">Закрити</button>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Існуючий код
            $("#close-attendance").on("click", function() {
                $("#attendance-modal").fadeOut();
            });
            $("#save-attendance").on("click", ()=> {
                
                let selectedDate = $("#date-select").val();
                let presentStudents = $("#student-list input:checked").map(function() {
                    return $(this).val();
                }).get();
                let lessonId = lessonData.id;
                let postData=[];
                presentStudents.forEach(studentId=>{
                    postData.push({ date: selectedDate, kid: studentId, lesson: lessonId });
                })
                let transactions = [];
                presentStudents.forEach(studentId => {
                    transactions.push({ kid: studentId, date: selectedDate, sum: lessonPrice, type: 4 });
                });
                
                $.ajax({
                    type: "POST",
                    url: "http://localhost:8080/attendance/lesson",
                    contentType: "application/json",
                    data: JSON.stringify(postData),
                    success: function(response) {
                        alert("Відмітку збережено успішно!");
                        $.ajax({
                            type: "POST",
                            url: "http://localhost:8080/transaction/list",       
                            contentType: "application/json",
                            data: JSON.stringify(transactions),
                            success: function(response) {
                                console.log("Transactions saved successfully:", response);
                                alert("Транзакції збережено успішно!");
                            },
                            error: function(xhr, status, error) {
                                console.error("Error saving transactions:", error);
                            }
                        });
                        $("#attendance-modal").hide();

                    },
                    error: function(xhr, status, error) {
                        console.error("Error:", error);
                        alert("Сталася помилка при збереженні відмітки.");
                    }
                });
            });
            let lessonPrice;
            $.getJSON(
                `http://localhost:8080/lesson-price`,
                (data) => {
                    lessonPrice = data.price;
                }
            )
            let urlParams = new URLSearchParams(window.location.search);
            let teacherId = urlParams.get("id");
            if (!teacherId) {
                getUser().then((user) => {
                    if (!user) {
                        window.location.href = "https://yehormovchan.github.io/";
                        return;
                    }
                    teacherId = user.staff;
                    fillInfo(teacherId);
                    loadGroupsSchedule(teacherId); // Завантаження розкладу груп
                }, (error) => {
                    console.error("Error fetching user data:", error);
                });
                return;
            }
            else{
                fillInfo(teacherId);
                loadGroupsSchedule(teacherId); // Завантаження розкладу груп
            }
            var lessonData;

            function fillInfo(teacherId){
                $.getJSON(`http://localhost:8080/view/schedule/teacher=${teacherId}`, function(data) {
                    let monday = data.filter(item => item.dayOfWeek === 1);
                    let tuesday = data.filter(item => item.dayOfWeek === 2);
                    let wednesday = data.filter(item => item.dayOfWeek === 3);
                    let thursday = data.filter(item => item.dayOfWeek === 4);
                    let friday = data.filter(item => item.dayOfWeek === 5);

                    let schedule = [monday, tuesday, wednesday, thursday, friday];

                    let maxRows = 8;

                    for (let i = 0, time = 9; i < maxRows; i++, time++) {
                        let tr = document.createElement("tr");
                        tr.appendChild(document.createElement("td")).innerText = `${i + 1} (${time}:00 - ${time}:45)`;
                        let td;
                        for (let j = 0; j < schedule.length; j++) {
                            td = document.createElement("td");
                            td.className = "lesson-cell";
                            if(schedule[j][i] !== undefined) {
                                td.dataset.info =JSON.stringify(schedule[j][i]);
                                td.innerText=  `${schedule[j][i].subjectName} (${schedule[j][i].classField})`;
                                td.style.cursor = "pointer";
                                td.onclick = ()=>{
                                    let lesson = schedule[j][i];
                                    if (!lesson) return;
                                    lessonData = lesson;
                                    $("#lesson-info").html(`${lesson.subjectName}  (${lesson.classField})`);

                                    
                                    let dateOptions = "";
                                    let today = new Date();
                                    for (let k = 0; k < 5; k++) {
                                        let date = new Date();
                                        date.setDate(today.getDate() - (today.getDay() - lesson.dayOfWeek) - (k * 7));
                                        dateOptions += `<option value="${date.toISOString().split('T')[0]}">${date.toLocaleDateString()}</option>`;
                                    }
                                    $("#date-select").html(dateOptions);


                                    $.getJSON(`http://localhost:8080/kid/grade=${lesson.classField}`, function(students) {
                                        let studentList = students.map(student => `<li><input type="checkbox" value="${student.id}"> ${student.name}</li>`).join("");
                                        $("#student-list").html(studentList);
                                    });
                                    
                                    $("#attendance-modal").show();
                                }
                                tr.appendChild(td);
                            }

                        }
                        $("#schedule-body").append(tr);
                    }
                   
                });
            }

            // Нова функція для завантаження та відображення розкладу груп
            function loadGroupsSchedule(teacherId) {
                $.getJSON(`http://localhost:8080/view/groups-schedule/leader=${teacherId}`, function(data) {
                    // Очищаємо таблицю перед заповненням
                    $("#groups-schedule-body").empty();
                    
                    // Маппінг для днів тижня
                    const daysOfWeek = {
                        1: "Понеділок",
                        2: "Вівторок",
                        3: "Середа",
                        4: "Четвер",
                        5: "П'ятниця",
                        6: "Субота",
                        7: "Неділя"
                    };
                    
                    // Сортуємо дані за днем тижня та часом початку
                    data.sort((a, b) => {
                        if (a.dayOfWeek !== b.dayOfWeek) {
                            return a.dayOfWeek - b.dayOfWeek;
                        }
                        return a.startTime.localeCompare(b.startTime);
                    });
                    
                    // Заповнюємо таблицю даними
                    data.forEach(item => {
                        let row = `
                            <tr>
                                <td class="day-column">${daysOfWeek[item.dayOfWeek]}</td>
                                <td>${item.group}</td>
                                <td>${item.startTime.substring(0, 5)}</td>
                                <td>${item.endTime.substring(0, 5)}</td>
                                <td>
                                    <button class="attendance-btn" data-group-id="${item.groupId}">Відмітка відвідування</button>
                                </td>
                            </tr>
                        `;
                        $("#groups-schedule-body").append(row);
                    });
                    
                    // Додаємо обробник подій для кнопок відмітки відвідування
                    $(".attendance-btn").on("click", function() {
                        const groupId = $(this).data("group-id");
                        // Тут можна додати логіку для відкриття модального вікна відмітки відвідування для групи
                        alert("Відмітка відвідування для групи ID: " + groupId);
                        // TODO: Розробити функціонал відмітки відвідування груп
                    });
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error("Помилка при завантаженні розкладу груп:", errorThrown);
                    $("#groups-schedule-body").html(`
                        <tr>
                            <td colspan="5">Помилка при завантаженні розкладу груп</td>
                        </tr>
                    `);
                });
            }
        });
    </script>
</body>
</html>