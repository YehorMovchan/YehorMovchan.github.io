<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Розклад занять</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://yehormovchan.github.io/static/style.css">
    <script src="https://yehormovchan.github.io/static/script.js"></script>
    <link rel="stylesheet" href="https://yehormovchan.github.io/static/iframe-styles.css">
</head>
<body>
    <div class="headline">
        <h1>Розклад занять</h1>
    </div>

    <div class="view-controls">
        <div class="radio-group">
            <label class="radio-item">
                <input type="radio" name="schedule-view" value="grade" checked>
                Розклад для класу
            </label>
            <label class="radio-item">
                <input type="radio" name="schedule-view" value="teacher">
                Розклад для вчителя
            </label>
        </div>

        <div class="filter-menu">
            <!-- Фільтр для класів -->
            <div id="grade-filter">
                <select id="grade-select">
                    <option value="">Оберіть клас</option>
                    <!-- Класи від 1 до 11 -->
                </select>
            </div>
            
            <!-- Фільтр для вчителів -->
            <div id="teacher-filter" class="hidden">
                <select id="teacher-select">
                    <option value="">Оберіть вчителя</option>
                    <!-- Список вчителів з API -->
                </select>
            </div>
            
            <button id="load-schedule">Показати розклад</button>
        </div>
    </div>

    <div class="schedule-container">
        <table id="schedule-table">
            <thead>
                <tr id="table-header">
                    <th>Урок/День</th>
                    <!-- Заголовки стовпців будуть додані через JavaScript -->
                </tr>
            </thead>
            <tbody id="schedule-body">
                <!-- Рядки таблиці будуть додані через JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        $(document).ready(function() {
            // Ініціалізація
            let currentView = 'grade'; // За замовчуванням - розклад для класу
            let teachers = []; // Масив вчителів
            
            // Заповнюємо вибір класів
            function populateGrades() {
                const gradeSelect = $("#grade-select");
                gradeSelect.find('option:not(:first)').remove();
                
                for (let i = 1; i <= 11; i++) {
                    gradeSelect.append(`<option value="${i}">${i}-й клас</option>`);
                }
            }
            
            // Завантаження списку вчителів
            function loadTeachers() {
                $.ajax({
                    url: "https://school-f6vi.onrender.com/staff/teachers",
                    method: 'get',
                    dataType: 'json',
                    success: (data) => {
                        teachers = data;
                        populateTeachers();
                    },
                    error: (err) => {
                        console.error("Помилка завантаження вчителів:", err);
                        alert("Не вдалося завантажити список вчителів. Спробуйте пізніше.");
                    }
                });
            }
            
            // Заповнюємо вибір вчителів
            function populateTeachers() {
                const teacherSelect = $("#teacher-select");
                teacherSelect.find('option:not(:first)').remove();
                
                teachers.forEach(teacher => {
                    teacherSelect.append(`<option value="${teacher.id}">${teacher.name}</option>`);
                });
            }
            
            // Перемикання режиму відображення
            $("input[name='schedule-view']").change(function() {
                currentView = $(this).val();
                
                if (currentView === 'grade') {
                    $("#grade-filter").removeClass("hidden");
                    $("#teacher-filter").addClass("hidden");
                } else {
                    $("#grade-filter").addClass("hidden");
                    $("#teacher-filter").removeClass("hidden");
                }
                
                // Очищаємо таблицю при зміні режиму
                resetScheduleTable();
            });
            
            // Завантаження розкладу
            $("#load-schedule").click(function() {
                let apiUrl;
                let selectedValue;
                
                if (currentView === 'grade') {
                    selectedValue = $("#grade-select").val();
                    if (!selectedValue) {
                        alert("Будь ласка, оберіть клас");
                        return;
                    }
                    apiUrl = `https://school-f6vi.onrender.com/view/schedule/grade=${selectedValue}`;
                } else {
                    selectedValue = $("#teacher-select").val();
                    if (!selectedValue) {
                        alert("Будь ласка, оберіть вчителя");
                        return;
                    }
                    apiUrl = `https://school-f6vi.onrender.com/view/schedule/teacher=${selectedValue}`;
                }
                
                loadSchedule(apiUrl);
            });
            
            // Функція завантаження розкладу з API
            function loadSchedule(apiUrl) {
                $.ajax({
                    url: apiUrl,
                    method: 'get',
                    dataType: 'json',
                    success: (data) => {
                        displaySchedule(data);
                    },
                    error: (err) => {
                        console.error("Помилка завантаження розкладу:", err);
                        alert("Не вдалося завантажити розклад. Спробуйте пізніше.");
                    }
                });
            }
            
            // Відображення розкладу залежно від режиму
            function displaySchedule(scheduleData) {
                resetScheduleTable();
                
                // Визначаємо заголовки таблиці залежно від режиму
                const headerRow = $("#table-header");
                const weekdays = ["Понеділок", "Вівторок", "Середа", "Четвер", "П'ятниця"];
                
                if (currentView === 'grade') {
                    // Для класу: уроки в рядках, дні в стовпцях
                    headerRow.empty().append("<th>Урок/День</th>");
                    weekdays.forEach(day => {
                        headerRow.append(`<th>${day}</th>`);
                    });
                    
                    // Визначаємо максимальну кількість уроків на день
                    let maxLessons = 0;
                    Object.values(scheduleData).forEach(daySchedule => {
                        if (daySchedule && daySchedule.length > maxLessons) {
                            maxLessons = daySchedule.length;
                        }
                    });
                    
                    // Створюємо рядки для кожного уроку
                    const scheduleBody = $("#schedule-body");
                    scheduleBody.empty();
                    
                    for (let i = 1; i <= maxLessons; i++) {
                        const row = $("<tr>");
                        row.append(`<th>${i}-й урок</th>`);
                        
                        weekdays.forEach((day, dayIndex) => {
                            const cell = $("<td class='schedule-cell'>");
                            const dayData = scheduleData[dayIndex + 1]; // Припускаємо, що дні нумеруються з 1
                            
                            if (dayData && dayData[i - 1]) {
                                const lesson = dayData[i - 1];
                                cell.append(`
                                    <div class="lesson-item">
                                        <div><strong>${lesson.subject}</strong></div>
                                        <div>${lesson.teacher}</div>
                                        <div>Кабінет: ${lesson.classroom || 'не вказано'}</div>
                                    </div>
                                `);
                            } else {
                                cell.append("<div class='no-data'>Немає уроку</div>");
                            }
                            
                            row.append(cell);
                        });
                        
                        scheduleBody.append(row);
                    }
                } else {
                    // Для вчителя: класи в рядках, дні в стовпцях
                    headerRow.empty().append("<th>Клас/День</th>");
                    weekdays.forEach(day => {
                        headerRow.append(`<th>${day}</th>`);
                    });
                    
                    // Знаходимо всі класи, які є в розкладі
                    const grades = new Set();
                    Object.values(scheduleData).forEach(daySchedule => {
                        if (daySchedule) {
                            daySchedule.forEach(lesson => {
                                if (lesson && lesson.grade) {
                                    grades.add(lesson.grade);
                                }
                            });
                        }
                    });
                    
                    // Створюємо рядки для кожного класу
                    const scheduleBody = $("#schedule-body");
                    scheduleBody.empty();
                    
                    Array.from(grades).sort().forEach(grade => {
                        const row = $("<tr>");
                        row.append(`<th>${grade}-й клас</th>`);
                        
                        weekdays.forEach((day, dayIndex) => {
                            const cell = $("<td class='schedule-cell'>");
                            const dayData = scheduleData[dayIndex + 1]; // Припускаємо, що дні нумеруються з 1
                            let hasLessons = false;
                            
                            if (dayData) {
                                const gradeLessons = dayData.filter(lesson => lesson && lesson.grade === grade);
                                
                                if (gradeLessons.length > 0) {
                                    hasLessons = true;
                                    gradeLessons.forEach(lesson => {
                                        cell.append(`
                                            <div class="lesson-item">
                                                <div><strong>${lesson.subject}</strong></div>
                                                <div>${lesson.lessonNumber}-й урок</div>
                                                <div>Кабінет: ${lesson.classroom || 'не вказано'}</div>
                                            </div>
                                        `);
                                    });
                                }
                            }
                            
                            if (!hasLessons) {
                                cell.append("<div class='no-data'>Немає уроків</div>");
                            }
                            
                            row.append(cell);
                        });
                        
                        scheduleBody.append(row);
                    });
                }
            }
            
            // Скидання таблиці розкладу
            function resetScheduleTable() {
                $("#table-header").html("<th>Урок/День</th>");
                $("#schedule-body").empty();
            }
            
            // Ініціалізація сторінки
            populateGrades();
            loadTeachers();
        });
    </script>
</body>
</html>